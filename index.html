<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karttapalaute – Leaflet + Google Sheets</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .popup-form { min-width: 220px; }
    .popup-form textarea { width: 100%; min-height: 70px; }
    .row { display: flex; gap: .5rem; margin-top: .5rem; justify-content: flex-end; }
    button { padding: .4rem .7rem; border: 1px solid #ccc; border-radius: .4rem; background: #f5f5f5; cursor: pointer; }
    button.primary { background: #2e7d32; color: white; border-color: #2e7d32; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxmIVh417UOeV8B_Ra46Dpi9OCFoSs45uelkHLnWYYAt2TT92GKNFRG36962gCNIUB1/exec";

// --- Luo kartta ---
const map = L.map('map').setView([62.0, 25.0], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

// --- Klikkaus kartalle ---
map.on('click', (e) => {
  const { lat, lng } = e.latlng;
  const marker = L.marker([lat, lng]).addTo(map);

  const formHtml = `
    <div class="popup-form">
      <label><strong>Kuvaile lyhyesti:</strong></label><br/>
      <textarea id="comment"></textarea>
      <div class="row">
        <button type="button" class="cancel">Peruuta</button>
        <button type="button" class="save primary">Tallenna</button>
      </div>
    </div>
  `;
  marker.bindPopup(formHtml).openPopup();

  marker.on("popupopen", () => {
    const container = marker.getPopup().getElement();
    const cancelBtn = container.querySelector(".cancel");
    const saveBtn = container.querySelector(".save");
    const textarea = container.querySelector("#comment");

    // Peruuta
    cancelBtn.addEventListener("click", () => {
      map.removeLayer(marker);
    });

    // Tallenna
    saveBtn.addEventListener("click", async () => {
      const comment = textarea.value.trim();
      saveBtn.disabled = true;
      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat, lng, comment })
        });
        const text = await res.text();
        console.log("Server response:", text);
        marker.setPopupContent(
          `<div><strong>Tallennettu</strong><br/>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br/>` +
          (comment ? `"${comment.replace(/</g,"&lt;")}"` : "<em>(ei kommenttia)</em>") +
          `</div>`
        );
        marker.closePopup();
      } catch (err) {
        console.error("Tallennusvirhe", err);
        alert("Tallennus epäonnistui: " + err);
        map.removeLayer(marker);
      } finally {
        saveBtn.disabled = false;
      }
    });
  });
});
</script>
</body>
</html>
