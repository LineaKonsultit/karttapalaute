<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karttapalaute – Linea </title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .popup-form { min-width: 220px; }
    .popup-form textarea { width: 100%; min-height: 70px; }
    .row { display: flex; gap: .5rem; margin-top: .5rem; justify-content: flex-end; }
    button { padding: .4rem .7rem; border: 1px solid #ccc; border-radius: .4rem; background: #f5f5f5; cursor: pointer; }
    button.primary { background: #2e7d32; color: white; border-color: #2e7d32; }
    /* Toast-ilmoitus */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: .6rem 1rem;
      border-radius: .5rem;
      font-size: .95rem;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxmIVh417UOeV8B_Ra46Dpi9OCFoSs45uelkHLnWYYAt2TT92GKNFRG36962gCNIUB1/exec";

// --- Toast-ilmoitus ---
function showToast(msg, ms=2500) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), ms);
}

// --- AOI-viiva ---
const AOI_GEOJSON_TM35 = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","geometry":{"type":"LineString","coordinates":[
      [448367.549,6716436.53],[448352.43,6716410.2895],[448330.6255,6716372.1105],
      [448318.202,6716342.102],[448303.316,6716305.636],[448289.79,6716271.4695],
      [448279.5015,6716250.2885],[448263.097,6716221.362],[448245.6805,6716192.923],
      [448225.887,6716151.882],[448208.754,6716107.7845],[448187.418,6716056.09],
      [448170.214,6716024.939],[448160.344,6716005.063],[448151.8525,6715967.7095],
      [448150.5415,6715922.2755],[448148.014,6715892.133],[448145.051,6715876.27]
    ]},"properties":{}}
  ]
};

// --- Kartta ---
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- Koordinaattimuunnos ---
proj4.defs("EPSG:3067","+proj=utm +zone=35 +ellps=GRS80 +units=m +no_defs");
function reprojectTM35toWGS84(geojson){
  function conv([x,y]){ const [lon,lat]=proj4("EPSG:3067","WGS84",[x,y]); return [lon,lat]; }
  function mapCoords(c){ return (typeof c[0]==='number') ? conv(c) : c.map(mapCoords); }
  return {type:geojson.type,features:(geojson.features||[]).map(f=>({
    type:"Feature",properties:f.properties||{},geometry:{type:f.geometry.type,coordinates:mapCoords(f.geometry.coordinates)}
  }))};
}

// --- Viiva ---
const AOI_WGS84 = reprojectTM35toWGS84(AOI_GEOJSON_TM35);
const aoiLayer = L.geoJSON(AOI_WGS84,{ style:{color:'#ff8c00',weight:8,opacity:0.5} }).addTo(map);
map.fitBounds(aoiLayer.getBounds(),{padding:[20,20]});

// --- Klikkaus kartalle ---
map.on('click', (e) => {
  const { lat, lng } = e.latlng;
  const marker = L.marker([lat, lng]).addTo(map);

  // Popup DOM-elementtinä
  const div = document.createElement('div');
  div.className = "popup-form";
  div.innerHTML = `
    <label><strong>Kuvaile lyhyesti:</strong></label><br/>
    <textarea id="comment"></textarea>
    <div class="row">
      <button type="button" class="cancel">Peruuta</button>
      <button type="button" class="save primary">Tallenna</button>
    </div>
  `;

  // Peruuta
  div.querySelector(".cancel").addEventListener("click", () => {
    map.removeLayer(marker);
  });

  // Tallenna
  div.querySelector(".save").addEventListener("click", () => {
    const comment = div.querySelector("#comment").value.trim();

    // Vaihdetaan popup-teksti heti
    marker.setPopupContent("<div><em>Tallennetaan...</em></div>");

    // Lähetetään data taustalle
    fetch(WEB_APP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lat, lng, comment })
    });

    // Päivitetään popup näkyviin "Tallennettu"
    setTimeout(() => {
      marker.setPopupContent(
        `<div><strong>Tallennettu</strong><br/>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}<br/>` +
        (comment ? `"${comment.replace(/</g,"&lt;")}"` : "<em>(ei kommenttia)</em>") +
        `</div>`
      );
      marker.closePopup();
      showToast("Tallennettu onnistuneesti!");
    }, 800); // n. 0,8 sekunnin viive
  });

  marker.bindPopup(div).openPopup();
});
</script>
</body>
</html>
